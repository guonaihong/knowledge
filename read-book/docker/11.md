# 容器文件系统和性能问题

## 容器文件系统概述

- 容器运行依赖特定的文件系统，如OverlayFS，它不同于常规的文件系统如Ext4或XFS。

### 容器文件系统的作用

- 容器文件系统允许多个容器共享基础镜像，同时为每个容器提供独立的可写层。

## 性能测试问题

- 在Ubuntu 20.04宿主机上，容器的文件读写性能显著下降至Ubuntu 18.04宿主机上的1/8。

### 性能测试方法

- 使用`fio`工具测试容器中的文件读写性能，关注异步I/O和非缓冲I/O的性能。

### Ubuntu 18.04 vs Ubuntu 20.04

- Ubuntu 18.04（内核4.15）上的容器I/O性能约584MB/s带宽，150K IOPS。
- Ubuntu 20.04（内核5.4）上的容器I/O性能约70MB/s带宽，18K IOPS。

## OverlayFS 基础

- OverlayFS是UnionFS的一种实现，用于容器文件系统的Linux内核文件系统。

### OverlayFS组件

- **lowerdir**: 基础层，通常是只读的。
- **upperdir**: 顶层，可读写，容器的更改在此层反映。
- **merged**: 用户看到的挂载点目录，包含所有层的合并视图。
- **work**: 存放临时文件的目录，用于文件修改过程中的中间步骤。

### OverlayFS挂载命令示例

- 使用`mount -t overlay`命令挂载OverlayFS，指定lowerdir和upperdir。

### OverlayFS工作流程

1. 文件存在于lower层时，merged层反映lower层的内容。
2. 对文件的修改在upper层进行，merged层反映修改后的内容。
3. work目录用于处理文件变更时的临时需求。

## 性能差异分析

- 性能下降可能与Ubuntu 20.04的内核或文件系统配置有关。
- 需要进一步分析内核更新、文件系统配置或I/O调度程序的变化。

## 总结

- 容器文件系统，特别是OverlayFS，为容器提供了高效的共享和隔离机制。
- 宿主机的升级可能会影响容器的性能，需要对比分析不同版本之间的差异。
- OverlayFS通过将文件系统的不同层合并，提供了一种节省空间且功能强大的文件系统解决方案。
