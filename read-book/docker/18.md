# 容器网络配置知识点总结（续）

## 容器中发包乱序问题

- **问题背景**: 用户将应用程序从物理机迁移到容器后，发现容器中数据包重传数量增多。

## veth接口与网络重传

- veth接口成对使用，容器通过veth发送数据时，数据包会先发送给配对接口。

## 问题重现

- 使用 `iperf3` 命令测试容器向外发送数据，通过输出中的 "Retr" 列观察重传数据包数量。

## 判断重传原因

- 直接使用 `tcpdump` 抓包可能因数据量大而带来系统开销，尤其是在生产环境中不适用。
- 使用 `netstat` 命令查看协议栈中的丢包和重传情况。

## 快速重传（Fast Retransmit）

- **定义**: 发送端收到3个重复的ACK时，立即重传对应数据包，而不需要等待超时。
- **Linux实现**: 收到一个重复ACK后，结合SACK信息，Linux可能会立即重传数据。

## SACK（Selective Acknowledgement）

- SACK提供了接收端收到的所有包的序列信息，帮助发送端了解接收端数据接收情况。

## 乱序数据包处理

- 在Linux内核中，如果接收端已收到的数据与未收到的数据之间的量差异过大（超过 `reordering*mss_cache`），会触发立即重传。

## 容器veth接口与乱序

- veth接口发送数据时，数据包通过softirq异步处理，多核系统中可能出现乱序，增加重传几率。

## 解决方案

- 针对容器网络中出现的乱序问题，需要进一步研究和优化veth接口的处理机制，减少乱序发生。

## 性能影响

- 乱序包在云平台网络环境中引起的重传量可能远高于丢包引起的重传，需要重视并解决此问题。
