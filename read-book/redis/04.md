# Redis AOF日志知识点总结

## AOF日志概述

- **定义**：AOF日志是一种用于避免数据丢失的持久化机制，通过记录操作命令来保证数据的可靠性。
- **实现方式**：AOF采用写后日志方式，即先执行命令写入内存，然后记录日志。

## 写回策略

- **Always**：每个写命令执行完，立即同步地将日志写回磁盘。
  - 优点：可靠性高，基本不丢数据。
  - 缺点：性能影响较大。
- **Everysec**：每个写命令执行完，先写到内存缓冲区，每隔一秒写入磁盘。
  - 优点：性能适中。
  - 缺点：宕机时可能丢失最近一秒的数据。
- **No**：由操作系统控制何时将缓冲区内容写回磁盘。
  - 优点：性能好。
  - 缺点：宕机时可能丢失更多数据。

## AOF重写机制

- **目的**：控制AOF文件大小，避免因文件过大导致性能问题。
- **原理**：根据数据库当前状态，创建新的AOF文件，记录当前键值对的最新写入命令。
- **优点**：减少日志文件大小，提高恢复效率。
- **实现**：通过后台子进程`bgrewriteaof`完成，不阻塞主线程。

## AOF重写过程

1. **内存拷贝**：Redis执行fork操作，拷贝主线程内存给子进程`bgrewriteaof`。
2. **双日志保障**：主线程继续接收写命令并写入AOF缓冲区，同时将命令写入AOF重写缓冲区，保证数据不丢失。
3. **重写完成**：子进程完成数据重写后，新AOF文件替代旧文件。

## 系统设计中的取舍原则

- **Trade-off**：在性能和可靠性之间做出平衡选择。

## 思考问题

1. **AOF重写潜在阻塞风险**：重写过程中，fork子进程和AOF重写过程中父进程产生写入的场景可能存在阻塞。
2. **重写日志独立性**：AOF重写使用独立的日志，不共享AOF本身的日志，原因为何？

## 其他注意事项

- **Hugepage**：在使用Redis时，建议关闭Hugepage，以减少因fork操作导致的读写放大问题。

## 社区讨论

- **触发AOF重写时机**：由配置项`auto-aof-rewrite-min-size`和`auto-aof-rewrite-percentage`控制。
- **AOF全称**：Append Only File，表示文件只能追加写。
