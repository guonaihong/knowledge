# 脑裂：一次奇怪的数据丢失问题

## 脑裂定义

脑裂是指在主从集群中，同时存在两个主节点，它们都能接收写请求，导致客户端不确定应该向哪个主节点写入数据。

## 脑裂的影响

- 不同客户端可能向不同的主节点写入数据。
- 严重时，可能导致数据不一致和数据丢失。

## 脑裂发生原因分析

1. **数据同步问题**：主库数据未同步至从库即发生故障。
2. **客户端操作日志**：发现客户端在主从切换后仍与原主库通信。
3. **原主库假故障**：原主库未真正故障，但无法处理请求和响应心跳。

## 数据丢失原因

- 原主库在主从切换期间保存的新写数据，在降级为从库后与新主库全量同步时被清空。

## 如何应对脑裂问题

- **配置项限制**：使用Redis提供的配置项`min-slaves-to-write`和`min-slaves-max-lag`来限制主库接收请求的条件。
  - `min-slaves-to-write`：设置主库能进行数据同步的最少从库数量。
  - `min-slaves-max-lag`：设置从库给主库发送ACK消息的最大延迟。

## 解决方案示例

- 设定`min-slaves-to-write`为1，`min-slaves-max-lag`为12秒。
- 当主库发生假故障，无法响应哨兵心跳和从库同步，无法满足配置项要求，将限制接收客户端请求。
- 新主库上线后，只有新主库能接收请求，原主库降级后不会引发数据丢失。

## 小结

- 脑裂问题可以通过合理配置Redis的主从集群参数来预防。
- 确保在主从切换过程中，原主库不会接收新的写请求，避免数据丢失。
