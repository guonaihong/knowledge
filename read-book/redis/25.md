# Redis缓存与数据库数据一致性问题

## 数据一致性定义

- 缓存中有数据时，缓存数据需与数据库中值相同。
- 缓存中无数据时，数据库中的值必须是最新值。

## 缓存读写模式

- **读写缓存**：可接收写请求，需同步更新缓存和数据库。
- **只读缓存**：不接受写请求，新增数据直接写入数据库，删改数据需使缓存中数据无效。

## 读写缓存策略

- **同步直写策略**：更新缓存时同步更新数据库，保证数据一致性。
- 需使用事务机制保证更新的原子性。

## 只读缓存策略

- 新增数据：直接写入数据库，无需操作缓存。
- 删改数据：在数据库操作后使缓存中数据无效，导致缓存缺失，应用从数据库读取最新数据。

## 数据不一致问题及解决方案

1. **新增数据**：直接写入数据库，缓存无需操作，符合一致性。
2. **删改数据**：
   - 先删除缓存再更新数据库：存在线程A删除缓存后，线程B读取旧值并写入缓存的风险。
   - 先更新数据库再删除缓存：减少数据库压力，但需注意并发读请求导致的数据不一致。

## 解决方案

- **重试机制**：操作失败时，从消息队列重试。
- **延迟双删**：删除缓存后，延迟一段时间再次删除，确保其他线程从数据库读取最新数据。

## 延迟双删伪代码示例

```java
redis.delKey(x);
db.update(x);
Thread.sleep(N); // N为估算的线程读数据和写缓存的操作时间
redis.delKey(x);
```
