# Redis主从库同步知识点总结

## 主从库同步的目的

- 确保数据的一致性
- 实现高可靠性和读写分离

## 主从库同步的模式

1. **全量复制**
   - 首次同步时使用
   - 耗时，但不可避免
2. **基于长连接的命令传播**
   - 主从库正常运行后的常规同步阶段
3. **增量复制**
   - 网络断连后使用，避免全量复制开销

## 主从库第一次同步的三个阶段

1. **建立连接，协商同步**
   - 从库发送`psync`命令给主库
   - 主库响应`FULLRESYNC`，提供`runID`和`offset`
2. **主库生成RDB文件并发送给从库**
   - 主库执行`bgsave`生成RDB文件
   - 从库清空数据并加载RDB文件
3. **主库发送新写命令给从库**
   - 主库记录RDB生成后的写操作到`replication buffer`
   - 将`replication buffer`中的修改操作发送给从库

## 主从级联模式

- 分担全量复制时主库的压力
- 通过选择一个从库作为其他从库的同步源

## repl_backlog_buffer的使用

- 环形缓冲区，用于记录断连期间的主库写操作
- 避免网络断连时重新进行全量复制

## repl_backlog_size参数

- 控制缓冲区大小，降低数据不一致风险
- 计算公式：`缓冲空间大小 = 主入命令速度 * 操作大小 - 主从库间网络传输命令速度 * 操作大小`
- 实际应用中，通常将`repl_backlog_size`设置为计算结果的两倍

## 主库故障后的解决方案

- 将在后续课程中讨论

## 每课一问

- 为什么主从库间的复制不使用AOF？

## 建议

- 将一个Redis实例的数据库大小控制在几GB级别，减少全量复制开销
- 考虑使用切片集群分担单个主库的请求压力
