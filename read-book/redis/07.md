# Redis哨兵机制知识点总结

## 哨兵机制概述

- **哨兵机制**：Redis主从集群中实现主从库自动切换的关键机制。
- **主要任务**：监控、选主、通知。

## 监控任务

- 哨兵周期性地发送PING命令检测主从库在线状态。
- 主观下线：单个哨兵检测到主库未响应。
- 客观下线：多数哨兵认定主库主观下线，采用"少数服从多数"原则。

## 选主任务

- 筛选：排除不在线或网络状况不佳的从库。
- 打分机制：
  - 第一轮：优先级高的从库得分高。
  - 第二轮：与旧主库同步程度最接近的从库得分高。
  - 第三轮：ID号小的从库得分高。

## 通知任务

- 将新主库的连接信息通知给从库和客户端。

## 哨兵集群

- 多实例部署，减少误判率。
- 面临新挑战：如集群中实例故障影响判断和切换。

## 主从切换过程

- 在主库故障时，哨兵自动执行主从切换。
- 切换过程中可能影响客户端请求操作。

## 技术细节

- `master_repl_offset`：主库记录的最新写操作偏移量。
- `slave_repl_offset`：从库记录的复制进度偏移量。

## 版本优化

- Redis 4.0后，从库与新主库进行增量同步而非全量同步。

## 运维开销

- 哨兵机制降低了Redis集群的运维成本，提高了系统的高可用性。

## 社区讨论

- 如何获取已挂主库的`master_repl_offset`值？
- 主从切换后，从库同步是否需要全量同步？
