# MySQL逻辑架构和SQL查询语句执行过程

## MySQL架构概述

MySQL可以分为Server层和存储引擎层两部分。

### Server层

- 包括连接器、查询缓存、分析器、优化器、执行器等。
- 实现了MySQL的大多数核心服务功能和所有内置函数。

### 存储引擎层

- 负责数据的存储和提取。
- 支持InnoDB、MyISAM、Memory等多个存储引擎。
- InnoDB从MySQL 5.5.5版本开始成为默认存储引擎。

## SQL查询语句执行流程

### 连接器

- 管理连接和权限验证。
- 连接建立后，权限判断逻辑依赖于此时读到的权限。

### 查询缓存

- 检查之前是否执行过该查询语句，如果命中缓存，则直接返回结果。
- MySQL 8.0版本开始移除了查询缓存功能。

### 分析器

- 词法分析：识别SQL语句中的关键字和标识符。
- 语法分析：根据语法规则判断SQL语句是否正确。

### 优化器

- 决定使用哪个索引或表的连接顺序。
- 影响执行效率。

### 执行器

- 根据表的引擎定义，使用引擎提供的接口执行查询。
- 遍历表中的数据行，返回满足条件的结果集。

## 长连接与短连接

- 长连接：连接成功后，持续使用该连接。
- 短连接：每次执行完查询后断开连接，下次查询重新建立。

## 权限验证

- 权限验证在执行器阶段进行，如果用户没有查询权限，则返回错误。

## 索引的使用

- 有索引的表和无索引的表在执行器阶段的执行逻辑相似。
- 执行器调用引擎接口获取满足条件的数据行。

## 慢查询日志

- 记录了SQL语句执行过程中扫描的行数。

## 问题与解答

- 问题：如果表中没有字段k，执行`select * from T where k=1`会报什么错误？
  - 答案：在分析器阶段报错，错误信息为“Unknown column 'k' in 'where clause'”。
