## 索引的常见模型

### 索引定义

- 索引是用于提高数据库查询速度的数据结构。它类似于书的目录，可以快速找到所需内容而无需逐行扫描整个表。

### 哈希表

- 键值对存储结构
- 哈希函数快速定位
- 冲突通过链表解决
- 适合等值查询，不适合范围查询

### 有序数组

- 值有序存储
- 支持二分查找，时间复杂度O(log(N))
- 支持范围查询
- 更新数据时可能需要移动大量记录

### 搜索树（如二叉搜索树）

- 保持元素有序
- 复杂度O(log(N))，需保持平衡
- 多叉树更适用于数据库，减少磁盘I/O

## InnoDB的索引模型

- 表数据以B+树形式存放，称为索引组织表
- 每个索引对应一棵B+树
- 主键索引（聚索引）存整行数据
- 非主键索引（二级索引）存主键值

### 查询区别

- 主键查询直接索引
- 非主键查询需回表

## 索引维护

- B+树维护有序性，插入可能触发页分裂
- 页分裂影响性能和空间利用率

## 自增主键的优势

- 符合递增插入，避免数据移动和页分裂
- 减少非主键索引占用空间
  
  非主键索引更占空间的原因：
  非主键索引每个条目包含索引列的值还包含主键的值，以方便回表（通过主键找到数据行）。如果主键是一个较长字符串，那么非主键索引每个条目都会包含这个字符串，这样会显著增加非主键索引的存储空间。

## 业务字段做主键的场景

- 单索引需求
- 唯一索引要求

## 重建索引的考量

- 重建索引可能影响性能
- 需考虑索引的创建和删除方式

## 避免长事务的策略

### 应用开发端

1. 确认`setautocommit=0`的使用情况
2. 避免不必要的只读事务
3. 控制语句执行时间

### 数据库端

1. 监控`information_schema.innodb_trx`表
2. 使用工具如Percona的`ptkill`
3. 分析`general_log`以提前发现问题
4. 调整`innodb_undo_tablespaces`设置

## 小结

- B+树结构适合磁盘读写特性
- 自增主键通常更合理，但需考虑业务场景
- 重建索引需考虑优化方法
