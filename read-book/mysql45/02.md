# MySQL日志系统和更新语句执行流程

## 更新语句的执行流程

更新语句在MySQL中的执行流程涉及多个组件，包括连接器、分析器、优化器、执行器，以及两种重要的日志系统：redo log（重做日志）和binlog（归档日志）。

### 重要日志模块

- **Redo Log (重做日志)**: InnoDB存储引擎特有的物理日志，采用Write-Ahead Logging (WAL)技术，先写日志再写磁盘，保证crash-safe能力。
- **Binlog (归档日志)**: MySQL Server层的逻辑日志，记录了所有的逻辑操作，采用追加写的形式。

### Redo Log的工作机制

- 类似于酒店掌柜的粉板，用于临时记录更新操作，减少直接写入磁盘的IO和查找成本。
- 固定大小，循环写入，包含write pos（当前记录位置）和checkpoint（擦除位置）。

### Binlog的工作机制

- 记录原始的SQL逻辑，所有引擎都可以使用。
- 可以用于数据恢复和复制，文件写到一定大小后会切换到下一个，不会覆盖以前的日志。

### 两阶段提交

- 保证redo log和binlog逻辑一致性的机制。
- 先写入redo log到prepare状态，再写入binlog，最后提交事务，将redo log改为commit状态。

### 数据恢复过程

- 利用定期的全库备份和binlog进行数据恢复。
- 当需要恢复到指定时间点，从全量备份恢复，然后依次重放备份时间点后的binlog。

### 参数建议

- `innodb_flush_log_at_trx_commit`: 设置为1，每次事务的redo log直接持久化到磁盘，保证数据不丢失。
- `sync_binlog`: 设置为1，每次事务的binlog持久化到磁盘，保证binlog不丢失。

## 思考题

- 定期全量备份的周期取决于系统重要性，一天一备与一周一备相比，在什么场景下一天一备更有优势？
