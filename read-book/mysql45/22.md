# MySQL性能问题解决方案

## 短连接风暴
- 短连接可能导致连接数突然暴涨，影响MySQL性能。
- `max_connections`参数控制MySQL实例同时存在的连接数上限。

## 处理方法
1. **主动断开空闲连接**：使用`kill connection`命令。
2. **设置`wait_timeout`**：自动断开空闲过久的连接。
3. **查询事务状态**：通过`information_schema.innodb_trx`表判断连接是否在事务中。

## 风险提示
- 断开连接可能导致事务回滚或业务逻辑失败。
- 应用端需正确处理断线重连和重试机制。

## 慢查询性能问题
1. **索引设计**：索引未设计好可能导致查询性能问题。
2. **SQL语句优化**：语句未写好，未有效使用索引。
3. **MySQL索引选择**：MySQL可能选错索引。

## 解决方案
- **创建索引**：使用`alter table`语句优化索引。
- **查询重写**：使用MySQL 5.7的`query_rewrite`功能。
- **使用`force index`**：强制使用特定索引。

## QPS突增问题
- 业务高峰或应用bug可能导致QPS突增。

## 处理方法
1. **临时禁用功能**：从数据库端限制新功能访问。
2. **用户权限控制**：通过管理员账号控制用户权限。
3. **查询重写**：将压力最大的SQL语句重写以减轻压力。

## 风险提示
- 查询重写可能误伤其他功能。
- 重写操作风险高，需细致操作。

## 最佳实践
- 避免使用大量短连接。
- 确保应用代码能够处理连接异常断开。

## 预防措施
- **慢查询日志**：上线前开启慢查询日志，设置`long_query_time=0`。
- **回归测试**：在测试环境中模拟线上数据进行测试。
- **SQL审计**：通过审计减少需要重写操作的机会。

## 工具推荐
- `ptquerydigest`：用于分析慢查询日志的工具。

## 思考题
- 如何处理业务高峰期的临时性能问题？

## 课后问题解答
- 分析加锁规则，解释`session B`的`insert`语句被阻塞的原因。